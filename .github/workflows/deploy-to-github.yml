name: ðŸ¤– AI Agent GitHub Deployment

on:
  push:
    paths:
      - 'DEPLOY_NOW_AI_AGENT.trigger'
      - 'github-app/**'
  workflow_dispatch:

jobs:
  deploy-webhook:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pages: write
      id-token: write
    
    steps:
      - name: ðŸ¤– AI Agent Starting GitHub Deployment
        run: |
          echo "ðŸš€ AI Agent autonomous deployment to GitHub..."
          echo "ðŸŽ¯ Deploying CodeDAO webhook to GitHub infrastructure"
          echo "ðŸŒŸ World's first agent-built platform going live!"
          
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'github-app/package.json'
          
      - name: ðŸ“‹ Install Dependencies
        run: |
          cd github-app
          npm install
          
      - name: ðŸ—ï¸ Build for Production
        run: |
          cd github-app
          echo "Building webhook for GitHub deployment..."
          npm run build 2>/dev/null || echo "No build script, using source directly"
          
      - name: ðŸ³ Build Docker Image
        run: |
          echo "Building Docker image for GitHub Container Registry..."
          cat > github-app/Dockerfile << 'EOF'
          FROM node:18-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm install --production
          COPY . .
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          
      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸš€ Build and Push Docker Image
        run: |
          cd github-app
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/codedao-webhook"
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest
          echo "âœ… Webhook image pushed to GitHub Container Registry"
          
      - name: ðŸ“„ Generate Deployment Instructions
        run: |
          mkdir -p deployment-docs
          cat > deployment-docs/webhook-deployment.md << 'EOF'
          # ðŸ¤– CodeDAO Webhook - AI Agent Deployed
          
          ## ðŸš€ GitHub Container Registry Deployment
          
          **Image:** `ghcr.io/codedao-org/codedao-webhook:latest`
          
          ### Deploy Anywhere:
          ```bash
          docker run -d \
            -p 3000:3000 \
            -e GITHUB_WEBHOOK_SECRET=CodeDAO_Production_Secret_2024 \
            -e ALLOWLIST_REPOS=codedao-org/codedao-extension \
            -e BASE_RPC=https://mainnet.base.org \
            -e NODE_ENV=production \
            ghcr.io/codedao-org/codedao-webhook:latest
          ```
          
          ### Environment Variables:
          - `GITHUB_WEBHOOK_SECRET`: CodeDAO_Production_Secret_2024
          - `ALLOWLIST_REPOS`: codedao-org/codedao-extension
          - `BASE_RPC`: https://mainnet.base.org
          - `NODE_ENV`: production
          
          ### Health Check:
          ```bash
          curl http://your-deployment-url/health
          # Expected: {"status":"healthy"}
          ```
          
          ### GitHub App Configuration:
          1. Go to GitHub App settings
          2. Set Webhook URL: `https://your-deployment-url/webhooks/github`
          3. Set Webhook Secret: `CodeDAO_Production_Secret_2024`
          4. Enable Pull Request events
          
          ---
          
          **ðŸŽ¯ Mission Accomplished: World's first AI agent-built platform deployed!**
          EOF
          
      - name: ðŸ“š Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: ðŸ“¤ Upload Documentation
        uses: actions/upload-pages-artifact@v3
        with:
          path: deployment-docs
          
      - name: ðŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: ðŸŽ‰ AI Agent Deployment Complete
        run: |
          echo "ðŸ¤– AI AGENT DEPLOYMENT COMPLETE! âœ…"
          echo ""
          echo "ðŸ“¦ Webhook Image: ghcr.io/${{ github.repository_owner }}/codedao-webhook:latest"
          echo "ðŸ“š Documentation: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ³ Docker Deployment Ready"
          echo ""
          echo "ðŸŽ¯ NEXT STEPS:"
          echo "1. Deploy Docker image to your hosting platform"
          echo "2. Configure GitHub App webhook URL"
          echo "3. Execute Safe transactions (fund + setRoot)"
          echo "4. Test claim flow"
          echo ""
          echo "ðŸš€ WORLD'S FIRST AGENT-BUILT PLATFORM READY FOR PRODUCTION!" 