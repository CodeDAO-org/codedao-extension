<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeDAO - Secure Claim Hub</title>
    
    <!-- SECURITY: Content Security Policy - NO third-party scripts allowed -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://mainnet.base.org https://api.basescan.org; img-src 'self' data:;">
    
    <!-- SECURITY: Self-hosted styling only -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .security-notice {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .claim-card, .transparency-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .claim-card:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .status-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            width: 100%;
            margin-bottom: 12px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
        }
        
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }
        
        .merkle-info {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
            word-break: break-all;
            font-size: 14px;
        }
        
        .proof-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin: 4px 0;
            font-size: 12px;
        }
        
        .external-link {
            color: #60a5fa;
            text-decoration: underline;
        }
        
        .external-link:hover {
            color: #93c5fd;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 640px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 8px 0;
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
            color: #fbbf24;
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Security Notice -->
        <div class="security-notice">
            <h3>üõ°Ô∏è Secure Claim Environment</h3>
            <p><strong>Chain ID:</strong> 8453 (Base Mainnet) - Hardcoded & Enforced</p>
            <p><strong>Scripts:</strong> Self-hosted only, no CDN dependencies</p>
            <p><strong>Transparency:</strong> All Merkle roots and proofs exposed below</p>
        </div>
        
        <!-- Header -->
        <div class="header">
            <h1>üéÅ CodeDAO Claim Hub</h1>
            <p>Secure, transparent token claiming with full Merkle verification</p>
        </div>
        
        <!-- Status Card -->
        <div id="statusCard" class="status-card">
            <div id="statusContent">
                <div>üåê</div>
                <span>Connect your wallet to check eligibility</span>
            </div>
        </div>
        
        <!-- Wallet Connection -->
        <div id="walletSection" class="claim-card">
            <h3>üîó Connect Wallet</h3>
            <p>Connect to Base mainnet to check your CODE token eligibility</p>
            <button class="btn btn-primary" onclick="connectWallet()">
                Connect MetaMask/Coinbase Wallet
            </button>
        </div>
        
        <!-- Balance Info -->
        <div id="balanceInfo" class="claim-card hidden">
            <h3>üí∞ Your Balances</h3>
            <div class="grid">
                <div>
                    <strong>CODE Balance:</strong><br>
                    <span id="codeBalance">0 CODE</span>
                </div>
                <div>
                    <strong>sCODE Balance:</strong><br>
                    <span id="scodeBalance">0 sCODE</span>
                </div>
            </div>
        </div>
        
        <!-- Claim Section -->
        <div id="claimSection" class="claim-card hidden">
            <div id="claimDetails"></div>
        </div>
        
        <!-- Transparency Section - Always Visible -->
        <div class="transparency-card">
            <h3>üîç Full Transparency</h3>
            
            <!-- Current Epoch Info -->
            <div>
                <h4><strong>Current Epoch:</strong> #1</h4>
                <div class="merkle-info">
                    <strong>Merkle Root:</strong><br>
                    <span id="merkleRoot">0xd0faae85d7f2638ad3e41794a8144fcacc8ac0a40a86c0c9af7485d4fc52866f</span>
                </div>
                
                <div class="alert alert-info">
                    <strong>üìä Distribution Summary:</strong><br>
                    ‚Ä¢ Total Amount: 150 CODE<br>
                    ‚Ä¢ Total Claims: 2<br>
                    ‚Ä¢ Timestamp: 2025-08-11T16:16:46.817Z
                </div>
            </div>
            
            <!-- Contract Verification -->
            <div style="margin-top: 20px;">
                <h4><strong>üîó Verified Contracts</strong></h4>
                <div class="grid">
                    <a href="https://basescan.org/address/0x36653EFf30fa88765Cf12199A009DdcB2cF724a0#code" target="_blank" class="btn btn-info external-link">
                        üìã Epoch Distributor
                    </a>
                    <a href="https://basescan.org/address/0xe6F6f49F5865e5230fd2Dc90F9cC8440d8eA5f7c#code" target="_blank" class="btn btn-info external-link">
                        üè¶ Staking Vault
                    </a>
                </div>
                <a href="https://basescan.org/address/0x54B3FABD84277FBa55B6b2Fd77cF1A5b1Dc9599C#code" target="_blank" class="btn btn-info external-link">
                    ü™ô CODE Token Contract
                </a>
            </div>
            
            <!-- Safe Ownership Verification -->
            <div style="margin-top: 20px;">
                <h4><strong>üèõÔ∏è Safe Treasury Ownership</strong></h4>
                <div class="alert alert-info">
                    <strong>Treasury Safe:</strong> <a href="https://app.safe.global/base:0x813343d30065eAe9D1Be6521203f5C0874818C28" target="_blank" class="external-link">0x8133...8C28</a><br>
                    <strong>Holdings:</strong> 100M CODE (verified on BaseScan)<br>
                    <strong>Admin Roles:</strong> All critical functions controlled by Safe multisig
                </div>
                <a href="https://basescan.org/address/0x813343d30065eAe9D1Be6521203f5C0874818C28" target="_blank" class="btn btn-info external-link">
                    üîç View Treasury on BaseScan
                </a>
            </div>
            
            <!-- Simulate Claim Preview -->
            <div style="margin-top: 20px;">
                <h4><strong>üß™ Claim Simulation</strong></h4>
                <button class="btn btn-secondary" onclick="showSimulateClaim()">
                    Preview Claim Process (No Gas)
                </button>
            </div>
        </div>
        
        <!-- How to Earn -->
        <div id="howToEarnSection" class="claim-card hidden">
            <h4>üöÄ How to Earn CODE Tokens</h4>
            <div style="margin-top: 16px;">
                <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; margin: 8px 0;">
                    <strong>1Ô∏è‚É£ Install CodeDAO Extension</strong><br>
                    <small>Get the VS Code extension to track your contributions</small>
                </div>
                <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; margin: 8px 0;">
                    <strong>2Ô∏è‚É£ Submit Quality PRs</strong><br>
                    <small>Contribute to allowlisted repositories with meaningful code</small>
                </div>
                <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; margin: 8px 0;">
                    <strong>3Ô∏è‚É£ Earn Weekly Rewards</strong><br>
                    <small>Quality scoring system calculates your CODE rewards</small>
                </div>
                <div style="padding: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 8px; margin: 8px 0;">
                    <strong>4Ô∏è‚É£ Claim Your Tokens</strong><br>
                    <small>Return here weekly to claim accumulated rewards</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SECURITY: Embedded ethers.js to avoid CDN -->
    <script>
        // SECURITY: Hardcoded Base mainnet configuration
        const SECURITY_CONFIG = {
            REQUIRED_CHAIN_ID: 8453,
            RPC_URL: 'https://mainnet.base.org',
            CHAIN_NAME: 'Base',
            CURRENCY_SYMBOL: 'ETH',
            BLOCK_EXPLORER: 'https://basescan.org'
        };
        
        // SECURITY: Hardcoded contract addresses (no external config)
        const CONTRACTS = {
            codeToken: '0x54B3FABD84277FBa55B6b2Fd77cF1A5b1Dc9599C',
            stakingVault: '0xe6F6f49F5865e5230fd2Dc90F9cC8440d8eA5f7c',
            epochDistributor: '0x36653EFf30fa88765Cf12199A009DdcB2cF724a0',
            treasury: '0x813343d30065eAe9D1Be6521203f5C0874818C28'
        };
        
        // SECURITY: Hardcoded epoch data with full transparency
        const EPOCH_DATA = {
            epochId: 1,
            timestamp: "2025-08-11T16:16:46.817Z",
            description: "Epoch 1 - Manual Test Data",
            merkleRoot: "0xd0faae85d7f2638ad3e41794a8144fcacc8ac0a40a86c0c9af7485d4fc52866f",
            totalAmount: "150000000000000000000",
            totalClaims: 2,
            claims: {
                "0xE4E53F3C17FDe8EF635C0921fA340FD1808C16e9": {
                    cumulative: "100000000000000000000",
                    proof: ["0x4abeeadde9db207d3b8dd22ceae821f1cc5c74d281205aa0dd038cc9a327fb98"],
                    category: "Builder Rewards"
                },
                "0x813343d30065eAe9D1Be6521203f5C0874818C28": {
                    cumulative: "50000000000000000000", 
                    proof: ["0x71ea90f5d0ed175bb5f208204b8b4880400e97a80531a9955b8c5d5a7f06b1b5"],
                    category: "Treasury Test"
                }
            }
        };
        
        // Basic ERC20 ABI - only functions we need
        const codeTokenABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)"
        ];
        
        let userAddress = null;
        let provider = null;
        let signer = null;
        
        // SECURITY: Strict chain validation
        async function validateChain() {
            if (!provider) return false;
            
            try {
                const network = await provider.getNetwork();
                if (network.chainId !== SECURITY_CONFIG.REQUIRED_CHAIN_ID) {
                    updateStatus(`‚ùå Wrong network! Please switch to Base (Chain ID: ${SECURITY_CONFIG.REQUIRED_CHAIN_ID})`, 'error');
                    return false;
                }
                return true;
            } catch (error) {
                updateStatus('‚ùå Network validation failed', 'error');
                return false;
            }
        }
        
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                updateStatus('‚ùå No wallet detected. Please install MetaMask or Coinbase Wallet.', 'error');
                return;
            }
            
            try {
                updateStatus('üîÑ Connecting wallet...', 'loading');
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // SECURITY: Force chain validation
                const chainValid = await validateChain();
                if (!chainValid) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${SECURITY_CONFIG.REQUIRED_CHAIN_ID.toString(16)}` }],
                        });
                        // Re-validate after switch
                        if (!(await validateChain())) {
                            return;
                        }
                    } catch (switchError) {
                        updateStatus('‚ùå Failed to switch to Base network', 'error');
                        return;
                    }
                }
                
                updateStatus(`‚úÖ Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(-4)}`, 'success');
                
                document.getElementById('walletSection').classList.add('hidden');
                await checkEligibility();
                await checkBalances();
                
            } catch (error) {
                console.error('Connection error:', error);
                updateStatus('‚ùå Failed to connect wallet', 'error');
            }
        }
        
        async function checkEligibility() {
            const userClaim = EPOCH_DATA.claims[userAddress];
            if (userClaim) {
                showClaimSection(userClaim);
            } else {
                showHowToEarn();
            }
        }
        
        async function checkBalances() {
            if (!provider || !userAddress) return;
            
            try {
                const codeToken = new ethers.Contract(CONTRACTS.codeToken, codeTokenABI, provider);
                const stakingVault = new ethers.Contract(CONTRACTS.stakingVault, codeTokenABI, signer);
                
                const codeBalance = await codeToken.balanceOf(userAddress);
                const scodeBalance = await stakingVault.balanceOf(userAddress);
                
                document.getElementById('codeBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(codeBalance)).toFixed(2) + ' CODE';
                document.getElementById('scodeBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(scodeBalance)).toFixed(2) + ' sCODE';
                
                document.getElementById('balanceInfo').classList.remove('hidden');
                
            } catch (error) {
                console.log('Balance check failed:', error.message);
            }
        }
        
        function showClaimSection(claimData) {
            const claimSection = document.getElementById('claimSection');
            const claimDetails = document.getElementById('claimDetails');
            
            const amount = ethers.utils.formatEther(claimData.cumulative);
            
            claimDetails.innerHTML = `
                <h3>üéâ Claimable Tokens Found!</h3>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: #10b981; margin: 10px 0;">
                        ${parseFloat(amount).toFixed(0)} CODE
                    </div>
                    <div style="opacity: 0.8;">Available to claim</div>
                    <div style="font-size: 0.9rem; opacity: 0.6; margin-top: 5px;">Category: ${claimData.category}</div>
                </div>
                
                <!-- Merkle Proof Transparency -->
                <div style="margin: 20px 0;">
                    <h4><strong>üîç Your Claim Proof</strong></h4>
                    <div class="merkle-info">
                        <strong>Amount:</strong> ${amount} CODE<br>
                        <strong>Merkle Root:</strong> ${EPOCH_DATA.merkleRoot}
                    </div>
                    <div style="margin-top: 8px;">
                        <strong>Proof Hash(es):</strong>
                        ${claimData.proof.map(hash => `<div class="proof-item">${hash}</div>`).join('')}
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è DEMO MODE:</strong> Actual claiming requires real transaction signing and gas fees
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="simulateClaim(false)">
                        ü™ô Simulate Claim to Wallet
                    </button>
                    <button class="btn btn-secondary" onclick="simulateClaim(true)">
                        üöÄ Simulate Claim & Stake (Recommended)
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 16px; opacity: 0.8; font-size: 0.9rem;">
                    üí° Staking gives you sCODE for governance voting and premium features
                </div>
            `;
            
            claimSection.classList.remove('hidden');
        }
        
        function showHowToEarn() {
            document.getElementById('howToEarnSection').classList.remove('hidden');
            updateStatus('üí° No claimable tokens found. See how to earn below!', 'info');
        }
        
        function showSimulateClaim() {
            alert(`üß™ Claim Simulation Preview:

1. Connect to Base mainnet (Chain ID: 8453) ‚úÖ
2. Verify Merkle proof against root: ${EPOCH_DATA.merkleRoot}
3. Call EpochDistributor.claim() with your proof
4. Choose: Direct to wallet OR stake for sCODE
5. Pay Base network gas fee (typically ~$0.01)

üîó Distributor Contract: ${CONTRACTS.epochDistributor}
üîó Verified on BaseScan: https://basescan.org/address/${CONTRACTS.epochDistributor}#code

‚ö†Ô∏è This is simulation only - real claims require transaction signing!`);
        }
        
        async function simulateClaim(autoStake) {
            const userClaim = EPOCH_DATA.claims[userAddress];
            if (!userClaim) {
                updateStatus('‚ùå No claim data found', 'error');
                return;
            }
            
            try {
                updateStatus(`üîÑ Simulating ${autoStake ? 'claim & stake' : 'claim'}...`, 'loading');
                
                // Simulate realistic delay
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                if (autoStake) {
                    updateStatus('‚úÖ Simulation: Claimed and staked! You would now have sCODE for premium features.', 'success');
                } else {
                    updateStatus('‚úÖ Simulation: Claimed successfully! CODE tokens would be sent to your wallet.', 'success');
                }
                
                // Show what would happen
                const amount = ethers.utils.formatEther(userClaim.cumulative);
                alert(`üéâ Claim Simulation Complete!

Amount: ${parseFloat(amount).toFixed(0)} CODE
Method: ${autoStake ? 'Claim & Stake' : 'Direct to Wallet'}
Gas Estimate: ~$0.01 USD

Next Steps in Real Claim:
1. Sign transaction with MetaMask/Coinbase
2. Pay Base network gas fee
3. Tokens ${autoStake ? 'staked as sCODE' : 'sent to wallet'}
4. Update your balances above

üîó Transaction would be visible on: https://basescan.org`);
                
                document.getElementById('claimSection').classList.add('hidden');
                
            } catch (error) {
                console.error('Simulation error:', error);
                updateStatus(`‚ùå Simulation failed: ${error.message}`, 'error');
            }
        }
        
        function updateStatus(message, type) {
            const statusContent = document.getElementById('statusContent');
            const statusCard = document.getElementById('statusCard');
            
            statusCard.className = 'status-card';
            if (type) statusCard.classList.add(type);
            
            let icon = 'üåê';
            if (type === 'loading') icon = '<div class="loading"></div>';
            else if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'info') icon = 'üí°';
            
            statusContent.innerHTML = `
                <div>${icon}</div>
                <span>${message}</span>
            `;
        }
        
        // Auto-connect if wallet already connected
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
        
        // Listen for account/chain changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    connectWallet();
                }
            });
            
            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html> 