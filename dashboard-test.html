<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeDAO Dashboard - AI Agent Control Center</title>
    <script src="https://unpkg.com/moralis-v1/dist/moralis.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            line-height: 1.6;
        }

        .header {
            background: #000;
            border-bottom: 1px solid #333;
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background-color: #0070f3;
        }

        .main {
            padding-top: 100px;
            max-width: 1200px;
            margin: 0 auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .live-banner {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 200% 200%;
            animation: gradient 3s ease infinite;
            color: #fff;
            text-align: center;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-weight: bold;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .hero {
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-description {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 3rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 3rem;
        }

        .cta-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .cta-btn:hover {
            transform: translateY(-2px);
        }

        .cta-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
        }

        .calculation-demo {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }

        .calculation-demo h3 {
            margin-bottom: 1rem;
            color: #fff;
        }

        .calc-display {
            font-size: 1.2rem;
            margin: 1rem 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .calc-result {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
            margin: 1rem 0;
        }

        .calc-note {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        .wallet-section {
            text-align: center;
            margin: 3rem 0;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .connect-btn {
            background: linear-gradient(135deg, #0070f3, #00d4ff);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 112, 243, 0.3);
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
        }

        .hidden {
            display: none;
        }

        /* Smart Suggestions Panel */
        .smart-suggestions {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .smart-suggestions:hover {
            transform: translateY(-50%) translateX(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .suggestions-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
        }

        .suggestion-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .suggestion-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fff;
            font-size: 0.9rem;
        }

        .suggestion-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .help-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .help-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .agent-status {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .agent-status h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
        }

        .status-offline {
            color: #ef4444;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-loading {
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-online {
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* GitHub Integration Styles */
        .github-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .github-section h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .github-section p {
            color: #666;
            margin-bottom: 1rem;
        }

        .github-token-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .github-token-input label {
            font-weight: 600;
            color: #333;
        }

        .github-token-input input {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .github-token-input input:focus {
            outline: none;
            border-color: #0070f3;
        }

        .github-btn {
            background: linear-gradient(135deg, #24292e, #0366d6);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .github-btn:hover {
            transform: translateY(-2px);
        }

        .github-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        .github-actions {
            margin-top: 1rem;
        }

        .github-actions h4 {
            color: #333;
            margin-bottom: 0.75rem;
        }

        .action-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-btn:enabled {
            background: #0070f3;
        }

        .action-btn:enabled:hover {
            background: #0051cc;
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .cta-buttons {
                flex-direction: column;
                align-items: center;
            }

            .smart-suggestions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="brand">
                <span>⚡</span>
                <span>CodeDAO</span>
                        </div>
            <div class="nav-links">
                <a href="#" class="nav-link active">AI Agent Control</a>
                <a href="https://codedao-org.github.io/peer-review.html" class="nav-link">Peer Review</a>
                <a href="https://codedao-org.github.io/how-it-works.html" class="nav-link">How It Works</a>
                <a href="https://codedao-org.github.io/get-started.html" class="nav-link">Get Started</a>
                <a href="https://codedao-org.github.io/about.html" class="nav-link">About</a>
                <a href="https://codedao-org.github.io/tokenomics.html" class="nav-link">Tokenomics</a>
                <a href="https://github.com/CodeDAO-org" class="nav-link">GitHub</a>
                        </div>
        </nav>
    </header>

    <main class="main">
        <div class="live-banner">
            🔥 LIVE: AI Agent Control System Active - Submit Tasks to Real AI Agents! 🔥
    </div>

        <section class="hero">
            <h1 class="hero-title">Control AI Agents.<br>Execute Real Tasks.</h1>
            
            <p class="hero-subtitle">First AI Agent Control System for Autonomous Development</p>
            
            <p class="hero-description">
                Submit tasks directly to AI agents and watch them execute real development work. 
                From code reviews to smart contract deployments - AI agents that actually DO.
            </p>
            
            <div class="cta-buttons">
                <button class="cta-btn" id="connectWalletBtn">Connect Wallet & Start</button>
                <a href="#agents" class="cta-btn secondary">Try AI Agents</a>
                            </div>
        </section>

        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">💰</div>
                <div class="stat-label">CODE Balance</div>
                <div class="stat-value" id="codeBalance">0.00 CODE</div>
                            </div>

            <div class="stat-card">
                <div class="stat-icon">🤖</div>
                <div class="stat-label">Active Agents</div>
                <div class="stat-value" id="activeAgents">0</div>
                        </div>
            
            <div class="stat-card">
                <div class="stat-icon">📋</div>
                <div class="stat-label">Tasks Completed</div>
                <div class="stat-value" id="tasksCompleted">0</div>
                    </div>
                    
            <div class="stat-card">
                <div class="stat-icon">⚡</div>
                <div class="stat-label">Wallet Status</div>
                <div class="stat-value" id="walletStatus">Not Connected</div>
                            </div>
        </section>

        <section class="calculation-demo">
            <h3>Real-time AI agent task calculation</h3>
            <div class="calc-display" id="calcDisplay">3 tasks × 2.5 CODE × 1.8 quality</div>
            <div class="calc-result" id="calcResult">13.5 CODE earned</div>
            <div class="calc-note">Live example from actual AI agent tasks</div>
        </section>

        <section class="wallet-section">
            <button id="connectWallet" class="connect-btn">🦊 Connect Wallet</button>
            <div id="walletInfo" class="wallet-info hidden">
                <p><strong>Address:</strong> <span id="userAddress"></span></p>
                <p><strong>Network:</strong> <span id="networkName">Base Mainnet</span></p>
                <p><strong>CODE Balance:</strong> <span id="userBalance">0.00 CODE</span></p>
            </div>

            <!-- GitHub Integration Section -->
            <div class="github-section">
                <h3>🐙 GitHub AI Agent Integration</h3>
                <p>Connect your GitHub to enable AI agents to push code directly to your repositories!</p>
                
                <div class="github-token-input">
                    <label for="githubToken">GitHub Personal Access Token:</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                    <button id="saveGithubToken" class="github-btn">🔗 Connect GitHub</button>
                        </div>
                
                <div id="githubStatus" class="github-status hidden">
                    <span class="status-indicator"></span>
                    <span id="githubStatusText">GitHub Connected!</span>
                        </div>
                
                <div class="github-actions">
                    <h4>Quick GitHub Actions:</h4>
                    <button id="testGithubPush" class="action-btn" disabled>🚀 Test Push</button>
                    <button id="createTestPR" class="action-btn" disabled>📝 Create Test PR</button>
                    <button id="getRepoInfo" class="action-btn" disabled>📊 Get Repo Info</button>
                    </div>
                    </div>
        </section>
    </main>

    <!-- Smart Suggestions Panel -->
    <div class="smart-suggestions">
        <div class="suggestions-header">
            <span>💡</span>
            <span>Smart Suggestions:</span>
                        </div>
                        
        <div class="suggestion-card">
            <div class="suggestion-title">Connect Wallet</div>
            <div class="suggestion-desc">I notice your wallet isn't connected. Would you like help with wallet integration?</div>
            <button class="help-btn" onclick="connectWallet()">Help Me</button>
                </div>

        <div class="suggestion-card">
            <div class="suggestion-title">Earn CODE Tokens</div>
            <div class="suggestion-desc">Let me help you set up the VS Code extension to start earning CODE tokens for coding!</div>
            <button class="help-btn" onclick="showTokenGuide()">Help Me</button>
                </div>

        <div class="suggestion-card">
            <div class="suggestion-title">Dashboard Optimization</div>
            <div class="suggestion-desc">I can analyze your dashboard and suggest performance improvements.</div>
            <button class="help-btn" onclick="optimizeDashboard()">Help Me</button>
                </div>

        <div class="agent-status">
            <h4>🤖 Agent Control Center</h4>
            <div class="status-item">
                <span>Gateway:</span>
                <span class="status-offline"><span class="status-dot"></span>Offline</span>
            </div>
            <div class="status-item">
                <span>Connected Agents:</span>
                <span class="status-loading"><span class="status-dot"></span>Loading agents...</span>
        </div>
            <div class="status-item">
                <span>Status:</span>
                <span id="connectionStatus">Not Connected</span>
    </div>
            </div>
            </div>

    <script>
        // ========== MORALIS WALLET CONNECTION SYSTEM ==========
        
        // Configuration
        const MORALIS_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6ImQzY2NjOTEzLTcwZDUtNGZkOC05ZmQzLTQxYjY1YmM3ZDljMiIsIm9yZ0lkIjoiNDYyNjY1IiwidXNlcklkIjoiNDc1OTg4IiwidHlwZUlkIjoiNGIzMzk5MDUtZjVlZC00N2FhLTliNmYtZjdiMDQ1NzgwODEzIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NTM5OTI2ODQsImV4cCI6NDkwOTc1MjY4NH0._82QL7vojD2DwHwh8U182qpZXqJ2lei_llw2Mdyl7fg";
        const CODE_TOKEN_ADDRESS = "0x1F8b43F7aeD0D1b524Ec5b4930C19098E8D4fbD0";
        const BASE_CHAIN_ID = "0x2105"; // Base Mainnet
        const BASE_RPC_URL = "https://mainnet.base.org";
        
        // Global state
        let currentAccount = null;
        let provider = null;
        let isConnecting = false;

        // Initialize Moralis
        async function initMoralis() {
            try {
                if (typeof Moralis !== 'undefined') {
                    await Moralis.start({ apiKey: MORALIS_API_KEY });
                    console.log("✅ Moralis initialized successfully");
                    return true;
                }
            } catch (error) {
                console.error("❌ Failed to initialize Moralis:", error);
                return false;
            }
        }

        // Connect wallet function
        async function connectWallet() {
            if (isConnecting) return;
            isConnecting = true;
            
            try {
                showNotification("🔄 Connecting wallet...");
                
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('MetaMask is not installed. Please install MetaMask to continue.');
                }

                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (typeof ethers !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                }
                
                currentAccount = accounts[0];
                await handleAccountConnection(accounts[0]);
                
                showNotification('🎉 Wallet connected successfully!');
                
            } catch (error) {
                console.error("❌ Wallet connection failed:", error);
                showNotification(`❌ Connection failed: ${error.message}`);
            } finally {
                isConnecting = false;
            }
        }

        // Handle successful connection
        async function handleAccountConnection(account) {
            currentAccount = account;
            
            // Update wallet status displays
            document.getElementById('walletStatus').textContent = 'Connected';
            document.getElementById('userAddress').textContent = formatAddress(account);
            
            // Update connect buttons
            const connectButtons = [
                document.getElementById('connectWallet'),
                document.getElementById('connectWalletBtn')
            ];
            
            connectButtons.forEach(button => {
                if (button) {
                    button.textContent = `Connected: ${formatAddress(account)}`;
                    button.disabled = true;
                    button.style.background = '#059669';
                }
            });
            
            // Show wallet info section
            const walletInfo = document.getElementById('walletInfo');
            if (walletInfo) {
                walletInfo.classList.remove('hidden');
            }
            
            // Load token balance
            await loadTokenBalance();
            
            // Setup listeners
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
            }
        }

        // Load CODE token balance
        async function loadTokenBalance() {
            if (!currentAccount || !provider) return;
            
            try {
                await ensureBaseNetwork();
                
                if (typeof ethers !== 'undefined') {
                    const contract = new ethers.Contract(
                        CODE_TOKEN_ADDRESS,
                        [
                            "function balanceOf(address owner) view returns (uint256)",
                            "function decimals() view returns (uint8)",
                            "function symbol() view returns (string)"
                        ],
                        provider
                    );

                    const balance = await contract.balanceOf(currentAccount);
                    const decimals = await contract.decimals();
                    
                    const formattedBalance = ethers.utils.formatUnits(balance, decimals);
                    const roundedBalance = parseFloat(formattedBalance).toFixed(2);
                    
                    // Update all balance displays
                    const balanceElements = [
                        document.getElementById('codeBalance'),
                        document.getElementById('userBalance')
                    ];
                    
                    balanceElements.forEach(element => {
                        if (element) {
                            element.textContent = `${roundedBalance} CODE`;
                        }
                    });
                    
                    console.log(`💰 CODE Balance: ${roundedBalance}`);
                }
            } catch (error) {
                console.error("❌ Error loading token balance:", error);
                
                const balanceElements = [
                    document.getElementById('codeBalance'),
                    document.getElementById('userBalance')
                ];
                
                balanceElements.forEach(element => {
                    if (element) {
                        element.textContent = "Error loading balance";
                    }
                });
            }
        }

        // Ensure user is on Base network
        async function ensureBaseNetwork() {
            if (!window.ethereum) return;
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_CHAIN_ID }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: [BASE_RPC_URL],
                                blockExplorerUrls: ['https://basescan.org/']
                            }],
                        });
                    } catch (addError) {
                        console.error("❌ Error adding Base network:", addError);
                    }
                }
            }
        }

        // Handle account changes
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else if (accounts[0] !== currentAccount) {
                handleAccountConnection(accounts[0]);
            }
        }

        // Handle chain changes
        function handleChainChanged(chainId) {
            console.log("🔄 Chain changed to:", chainId);
            if (currentAccount) {
                loadTokenBalance();
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            currentAccount = null;
            provider = null;
            
            // Reset status displays
            document.getElementById('walletStatus').textContent = 'Not Connected';
            document.getElementById('userAddress').textContent = '';
            
            // Reset balance displays
            const balanceElements = [
                document.getElementById('codeBalance'),
                document.getElementById('userBalance')
            ];
            
            balanceElements.forEach(element => {
                if (element) {
                    element.textContent = '0.00 CODE';
                }
            });
            
            // Reset connect buttons
            const connectButtons = [
                document.getElementById('connectWallet'),
                document.getElementById('connectWalletBtn')
            ];
            
            connectButtons.forEach(button => {
                if (button) {
                    button.textContent = 'Connect Wallet';
                    button.disabled = false;
                    button.style.background = '';
                }
            });
            
            // Hide wallet info
            const walletInfo = document.getElementById('walletInfo');
            if (walletInfo) {
                walletInfo.classList.add('hidden');
            }
            
            showNotification('🔌 Wallet disconnected');
        }

        // Format address for display
        function formatAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.9);
                color: white; padding: 15px 20px; border-radius: 10px; z-index: 1000;
                font-weight: 600; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // ========== ORIGINAL FUNCTIONS ==========

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 CodeDAO AI Agent Dashboard Loading...');
            
            // Initialize Moralis first
            await initMoralis();
            
            setupEventListeners();
            startAnimations();
            
            // Check if wallet is already connected
            checkWalletConnection();
        });

        function setupEventListeners() {
            // Connect both wallet buttons
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const connectWallet = document.getElementById('connectWallet');
            
            if (connectWalletBtn) {
                connectWalletBtn.addEventListener('click', connectWallet);
            }
            if (connectWallet) {
                connectWallet.addEventListener('click', connectWallet);
            }
        }

        function startAnimations() {
            // Animate agent statistics
            let agentCount = 0;
            let taskCount = 0;
            
            setInterval(() => {
                agentCount = Math.floor(Math.random() * 5) + 1;
                taskCount = Math.floor(Math.random() * 10) + taskCount;
                
                document.getElementById('activeAgents').textContent = agentCount;
                document.getElementById('tasksCompleted').textContent = taskCount;
                
                // Update calculation
                const tasks = Math.floor(Math.random() * 10) + 1;
                const rate = (Math.random() * 2 + 1.5).toFixed(1);
                const quality = (Math.random() * 0.5 + 1.5).toFixed(1);
                const earned = (tasks * rate * quality).toFixed(1);
                
                document.getElementById('calcDisplay').textContent = 
                    `${tasks} tasks × ${rate} CODE × ${quality} quality`;
                document.getElementById('calcResult').textContent = 
                    `${earned} CODE earned`;
            }, 3000);
        }

        function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            handleAccountConnection(accounts[0]);
                        }
                    });
            }
        }

        // Smart Suggestions Functions
        function showTokenGuide() {
            alert('🎯 To start earning CODE tokens:\n\n1. Install the CodeDAO VS Code extension\n2. Connect your wallet\n3. Start coding - you earn CODE for every line!\n\nCheck the GitHub repository for the extension.');
        }

        function optimizeDashboard() {
            alert('⚡ Dashboard optimization suggestions:\n\n1. Enable wallet connection for real-time balance\n2. Connect to AI agents for task automation\n3. Set up notifications for completed tasks\n\nWould you like help with any of these?');
        }

        // Update connection status based on wallet
        function updateConnectionStatus() {
            const walletStatus = document.getElementById('walletStatus').textContent;
            const connectionStatus = document.getElementById('connectionStatus');
            if (walletStatus === 'Connected') {
                connectionStatus.innerHTML = '<span class="status-online"><span class="status-dot"></span>Connected</span>';
            } else {
                connectionStatus.innerHTML = 'Not Connected';
            }
        }

        // Update status every few seconds
        setInterval(updateConnectionStatus, 2000);

        // ========== TOKEN APPROVALS FUNCTIONALITY ==========
        
        // Revoke approval function
        const revokeApproval = async (tokenAddress, spenderAddress) => {
            try {
                if (!provider) {
                    throw new Error('Wallet not connected');
                }
                
                const signer = provider.getSigner();
                const tokenContract = new ethers.Contract(
                    tokenAddress,
                    ["function approve(address spender, uint256 value) external returns (bool)"],
                    signer
                );
                
                const tx = await tokenContract.approve(spenderAddress, 0);
                await tx.wait();
                
                showNotification("✅ Approval revoked successfully!");
                
            } catch (error) {
                console.error("❌ Error revoking approval:", error);
                showNotification(`❌ Failed to revoke approval: ${error.message}`);
            }
        };
        
        // ========== GITHUB AI AGENT INTEGRATION ==========
        
        const AGENT_GATEWAY_URL = 'http://localhost:3001'; // Agent Gateway Server
        let githubConnected = false;
        let currentUserId = null;
        
        // Initialize GitHub integration on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeGitHubIntegration();
        });
        
        function initializeGitHubIntegration() {
            // Generate or get user ID (in production, use wallet address or authentication)
            currentUserId = localStorage.getItem('codedao_user_id') || generateUserId();
            localStorage.setItem('codedao_user_id', currentUserId);
            
            // Set up event listeners
            document.getElementById('saveGithubToken')?.addEventListener('click', saveGitHubToken);
            document.getElementById('testGithubPush')?.addEventListener('click', testGitHubPush);
            document.getElementById('createTestPR')?.addEventListener('click', createTestPR);
            document.getElementById('getRepoInfo')?.addEventListener('click', getRepoInfo);
            
            // Check if GitHub token is already saved
            checkGitHubStatus();
        }
        
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function saveGitHubToken() {
            const tokenInput = document.getElementById('githubToken');
            const token = tokenInput.value.trim();
            
            if (!token) {
                showNotification("❌ Please enter a GitHub token");
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showNotification("⚠️ Invalid GitHub token format");
                return;
            }
            
            try {
                showNotification("🔄 Connecting to GitHub...");
                
                const response = await fetch(`${AGENT_GATEWAY_URL}/api/user/add-github-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        githubToken: token
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    githubConnected = true;
                    updateGitHubStatus(true);
                    showNotification("✅ GitHub connected successfully!");
                    
                    // Clear the token input for security
                    tokenInput.value = '';
                    
                    // Enable action buttons
                    enableGitHubActions(true);
                } else {
                    throw new Error(result.error || 'Failed to connect GitHub');
                }
                
            } catch (error) {
                console.error('GitHub connection error:', error);
                showNotification(`❌ GitHub connection failed: ${error.message}`);
            }
        }
        
        async function testGitHubPush() {
            if (!githubConnected) {
                showNotification("❌ Please connect GitHub first");
                return;
            }
            
            try {
                showNotification("🚀 Testing GitHub push via AI agent...");
                
                const testFile = {
                    path: 'ai-agent-test.md',
                    content: `# AI Agent Test File
Generated by CodeDAO AI Agent Bot System
Timestamp: ${new Date().toISOString()}
User ID: ${currentUserId}

This file was created by an AI agent through the CodeDAO dashboard!

## Features Tested:
- ✅ GitHub API integration
- ✅ AI Agent Gateway communication
- ✅ Secure token handling
- ✅ Real-time dashboard updates

---
*Powered by CodeDAO AI Agent Control System*`
                };
                
                const response = await fetch(`${AGENT_GATEWAY_URL}/api/github/push`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        repo: 'codedao-extension',
                        files: [testFile],
                        commitMessage: '🤖 AI Agent Test: Automated push from CodeDAO dashboard',
                        agentId: 'Claude-Dashboard'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification("✅ GitHub push successful! Check your repository.");
                    console.log('Push results:', result);
                } else {
                    throw new Error(result.error || 'Push failed');
                }
                
            } catch (error) {
                console.error('GitHub push error:', error);
                showNotification(`❌ GitHub push failed: ${error.message}`);
            }
        }
        
        async function createTestPR() {
            if (!githubConnected) {
                showNotification("❌ Please connect GitHub first");
                return;
            }
            
            try {
                showNotification("📝 Creating test PR via AI agent...");
                
                const response = await fetch(`${AGENT_GATEWAY_URL}/api/github/create-pr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        repo: 'codedao-extension',
                        title: '🤖 AI Agent Test PR: Dashboard Integration',
                        body: `# AI Agent Generated Pull Request

This PR was automatically created by the CodeDAO AI Agent Bot System!

## Changes:
- AI agent test file created
- GitHub integration verified
- Dashboard communication confirmed

## Agent Details:
- **Agent ID**: Claude-Dashboard
- **User ID**: ${currentUserId}
- **Timestamp**: ${new Date().toISOString()}

---
*Generated automatically by CodeDAO AI Agent Control System*`,
                        head: 'ai-agent-test',
                        base: 'main',
                        agentId: 'Claude-Dashboard'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ PR created successfully! #${result.prNumber}`);
                    console.log('PR created:', result);
                } else {
                    throw new Error(result.error || 'PR creation failed');
                }
                
            } catch (error) {
                console.error('PR creation error:', error);
                showNotification(`❌ PR creation failed: ${error.message}`);
            }
        }
        
        async function getRepoInfo() {
            if (!githubConnected) {
                showNotification("❌ Please connect GitHub first");
                return;
            }
            
            try {
                showNotification("📊 Getting repository info...");
                
                const response = await fetch(`${AGENT_GATEWAY_URL}/api/github/repo-info/codedao-extension?userId=${currentUserId}`);
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`✅ Repository: ${result.fullName} | Private: ${result.private}`);
                    console.log('Repo info:', result);
                } else {
                    throw new Error(result.error || 'Failed to get repo info');
                }
                
            } catch (error) {
                console.error('Repo info error:', error);
                showNotification(`❌ Failed to get repo info: ${error.message}`);
            }
        }
        
        function updateGitHubStatus(connected) {
            const statusDiv = document.getElementById('githubStatus');
            const statusText = document.getElementById('githubStatusText');
            
            if (connected) {
                statusDiv.classList.remove('hidden');
                statusText.textContent = `GitHub connected! User ID: ${currentUserId}`;
            } else {
                statusDiv.classList.add('hidden');
            }
        }
        
        function enableGitHubActions(enabled) {
            const buttons = ['testGithubPush', 'createTestPR', 'getRepoInfo'];
            buttons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = !enabled;
                }
            });
        }
        
        function checkGitHubStatus() {
            // In a real implementation, this would check if the user's token is still valid
            // For now, we'll assume they need to reconnect each session
            githubConnected = false;
            updateGitHubStatus(false);
            enableGitHubActions(false);
        }
        
        // Make functions available globally
        window.connectWallet = connectWallet;
        window.revokeApproval = revokeApproval;
        window.showTokenGuide = showTokenGuide;
        window.optimizeDashboard = optimizeDashboard;
        window.saveGitHubToken = saveGitHubToken;
        window.testGitHubPush = testGitHubPush;
        window.createTestPR = createTestPR;
        window.getRepoInfo = getRepoInfo;
    </script>
</body>
</html>
